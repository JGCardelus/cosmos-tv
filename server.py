from flask import Flask, render_template, url_for
from flask_socketio import SocketIO, emit
from subprocess import call

import webbrowser as browser

import subprocess
import io
import socket


#SERVER CONFIGURATION & VARS
port_num = 50000

web = Flask(__name__)
web.config['SECRET_KEY'] = 'cosmostv-rules'

server = SocketIO(web)

#AUTOCOMPLETE FRONTEND IP
def change_frontend_connection():
    global port_num

    ip_addr = get_ip()

    client_server = open('static/engine/init.js', 'r')
    client_server_lines = client_server.readlines()
    for i, line in enumerate(client_server_lines):
        if line.rstrip().lstrip() == '//$SOCKET_IP':
            client_server_lines[i + 1] = 'socket = io.connect("http://' + ip_addr + ':'+ str(port_num) +'"); //This line was autogenerated.\n'
            break

    client_server = open('static/engine/init.js', 'w')
    client_server.writelines(client_server_lines)
    client_server.close()

def get_ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.connect(("1.1.1.1", 80))
    ip_addr = s.getsockname()[0]
    s.close()
    return ip_addr

if __name__ == '__main__':
    change_frontend_connection()
    print("Server starting at %s" % (str(get_ip())))
    server.run(web, host='0.0.0.0', port=port_num)